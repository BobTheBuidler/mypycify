name: Test mypycify Action

on:
  push:
  pull_request:

jobs:
  test-source:
    name: Build from source (no ccache)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up minimal Python project
        run: |
          echo '[build-system]' > pyproject.toml
          echo 'requires = ["setuptools", "wheel"]' >> pyproject.toml
          echo 'build-backend = "setuptools.build_meta"' >> pyproject.toml
          echo 'from setuptools import setup; setup(name="dummy", version="0.1")' > setup.py
          mkdir dummy
          echo '' > dummy/__init__.py
      - name: Run mypycify action (source, no ccache)
        uses: ./
        with:
          python-version: '3.11'
          pip-cache-dependency-path: pyproject.toml
          build-from: source
          ccache: 'false'
      - name: Check for built wheel
        run: |
          ls dist/
          test -f dist/dummy-0.1-py3-none-any.whl

  test-sdist:
    name: Build from sdist (no ccache)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up minimal Python project
        run: |
          echo '[build-system]' > pyproject.toml
          echo 'requires = ["setuptools", "wheel"]' >> pyproject.toml
          echo 'build-backend = "setuptools.build_meta"' >> pyproject.toml
          echo 'from setuptools import setup; setup(name="dummy", version="0.1")' > setup.py
          mkdir dummy
          echo '' > dummy/__init__.py
      - name: Run mypycify action (sdist, no ccache)
        uses: ./
        with:
          python-version: '3.11'
          pip-cache-dependency-path: pyproject.toml
          build-from: sdist
          ccache: 'false'
      - name: Check for built wheel
        run: |
          ls dist/
          test -f dist/dummy-0.1-py3-none-any.whl

  test-source-ccache:
    name: Build from source (with ccache)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up minimal Python project
        run: |
          echo '[build-system]' > pyproject.toml
          echo 'requires = ["setuptools", "wheel"]' >> pyproject.toml
          echo 'build-backend = "setuptools.build_meta"' >> pyproject.toml
          echo 'from setuptools import setup; setup(name="dummy", version="0.1")' > setup.py
          mkdir dummy
          echo '' > dummy/__init__.py
      - name: Run mypycify action (source, with ccache)
        uses: ./
        with:
          python-version: '3.11'
          pip-cache-dependency-path: pyproject.toml
          build-from: source
          ccache: 'true'
      - name: Check for built wheel
        run: |
          ls dist/
          test -f dist/dummy-0.1-py3-none-any.whl

  test-sdist-ccache:
    name: Build from sdist (with ccache)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up minimal Python project
        run: |
          echo '[build-system]' > pyproject.toml
          echo 'requires = ["setuptools", "wheel"]' >> pyproject.toml
          echo 'build-backend = "setuptools.build_meta"' >> pyproject.toml
          echo 'from setuptools import setup; setup(name="dummy", version="0.1")' > setup.py
          mkdir dummy
          echo '' > dummy/__init__.py
      - name: Run mypycify action (sdist, with ccache)
        uses: ./
        with:
          python-version: '3.11'
          pip-cache-dependency-path: pyproject.toml
          build-from: sdist
          ccache: 'true'
      - name: Check for built wheel
        run: |
          ls dist/
          test -f dist/dummy-0.1-py3-none-any.whl
